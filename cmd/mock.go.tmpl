{{- define "parameterWithTypeList" -}}
{{ range $i, $param := . }}{{ if $i }}, {{ end }}{{ $param.Name }} {{ $param.Type }}{{ end }}
{{- end -}}

{{- define "parameterList" -}}
{{ range $i, $param := . }}{{ if $i }}, {{ end }}{{ $param.Name }}{{ end }}
{{- end -}}

{{- define "resultWithTypeList" -}}
{{ range $i, $result := . }}{{ if $i }}, {{ end }}{{ if $result.Name }}{{ $result.Name }}{{ else }}r{{ $i }}{{ end }} {{ $result.Type }}{{ end }}
{{- end -}}

{{- define "resultList" -}}
{{ range $i, $result := . }}{{ if $i }}, {{ end }}{{ if $result.Name }}{{ $result.Name }}{{ else }}r{{ $i }}{{ end }}{{ end }}
{{- end -}}

{{- define "resultTypeList" -}}
{{ range $i, $result := . }}{{ if $i }}, {{ end }}{{ $result.Type }}{{ end }}
{{- end -}}

{{- define "observationCallback" -}}
func({{ template "parameterWithTypeList" .Parameters }}) ({{ template "resultTypeList" .Results }})
{{- end -}}

{{- define "matcherTypeParams" -}}
{{ range $i, $param := . }}{{ if ne $i 0 }}, {{ end }}P{{ $i }} {{ $param.Type }} | kelpie.Matcher[{{ $param.Type }}]{{ end }}
{{- end -}}

{{- define "matcherParams" -}}
{{ range $i, $param := . }}{{ if ne $i 0 }}, {{ end }}{{ $param.Name }} P{{ $i }}{{ end }}
{{- end -}}

// Code generated by Kelpie. DO NOT EDIT.
package {{ .PackageName }}

import "github.com/adamconnelly/kelpie"

type Mock struct {
	kelpie.Mock
	instance Instance
}

func NewMock() *Mock {
	mock := Mock{
		instance: Instance{},
	}
	mock.instance.mock = &mock

	return &mock
}

type Instance struct {
	mock *Mock
}

{{- range $method := .Methods }}

func (m *Instance) {{ $method.Name }}({{ template "parameterWithTypeList" $method.Parameters }}) ({{ template "resultWithTypeList" $method.Results }}) {
	expectation := m.mock.Call("{{ $method.Name }}", {{ template "parameterList" $method.Parameters }})
	if expectation != nil {
		if expectation.ObserveFn != nil {
			observe := expectation.ObserveFn.({{ template "observationCallback" $method }})
			return observe({{ template "parameterList" $method.Parameters }})
		}

		if expectation.PanicArg != nil {
			panic(expectation.PanicArg)
		}

		{{ range $i, $result := $method.Results }}
		if expectation.Returns[{{ $i }}] != nil {
			{{ if $result.Name }}{{ $result.Name }}{{ else }}r{{ $i }}{{ end }} = expectation.Returns[{{ $i }}].({{ $result.Type }})
		}
		{{ end }}
	}

	return
}
{{- end }}

func (m *Mock) Instance() *Instance {
	return &m.instance
}

{{ range $method := .Methods }}
type {{ $method.Name }}InvocationDetails struct {
	{{- range $param := $method.Parameters }}
	{{ $param.Name }} kelpie.Matcher[{{ $param.Type }}]
	{{- end }}
}

func {{ $method.Name }}[{{ template "matcherTypeParams" $method.Parameters }}]({{ template "matcherParams" $method.Parameters }}) {{ $method.Name }}InvocationDetails {
	result := {{ $method.Name }}InvocationDetails{}
{{ range $i, $param := $method.Parameters }}
	if matcher, ok := any({{ $param.Name }}).(kelpie.Matcher[{{ $param.Type }}]); ok {
		result.{{ $param.Name }} = matcher
	} else {
		result.{{ $param.Name }} = kelpie.ExactMatch(any({{ $param.Name }}).({{ $param.Type }}))
	}
{{ end }}
	return result
}

func (a {{ $method.Name }}InvocationDetails) Return({{ template "resultWithTypeList" $method.Results }}) *kelpie.Expectation {
	return &kelpie.Expectation{
		MethodName:       "{{ $method.Name }}",
		ArgumentMatchers: []kelpie.ArgumentMatcher{ {{- range $i, $param := $method.Parameters }}{{ if $i }}, {{ end }}a.{{ $param.Name }}{{ end -}} },
		Returns:          []any{ {{- template "resultList" $method.Results -}} },
	}
}

func (a {{ $method.Name }}InvocationDetails) Panic(arg any) *kelpie.Expectation {
	return &kelpie.Expectation{
		MethodName:       "{{ $method.Name }}",
		ArgumentMatchers: []kelpie.ArgumentMatcher{ {{- range $i, $param := $method.Parameters }}{{ if $i }}, {{ end }}a.{{ $param.Name }}{{ end -}} },
		PanicArg:         arg,
	}
}

func (a {{ $method.Name }}InvocationDetails) When(observe {{ template "observationCallback" $method }}) *kelpie.Expectation {
	return &kelpie.Expectation{
		MethodName:       "{{ $method.Name }}",
		ArgumentMatchers: []kelpie.ArgumentMatcher{ {{- range $i, $param := $method.Parameters }}{{ if $i }}, {{ end }}a.{{ $param.Name }}{{ end -}} },
		ObserveFn:        observe,
	}
}
{{- end }}
